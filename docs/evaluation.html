

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Evaluation &mdash; slideflow 1.11.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Layer activations" href="activations.html" />
    <link rel="prev" title="Training" href="training.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="root.html" class="icon icon-home"> slideflow
          

          
          </a>

          
            
            
              <div class="version">
                1.11
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipeline.html">Pipeline Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="project.html">Setting up a Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="validation.html">Validation Planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="extract_tiles.html">Tile extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="training.html">Training</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Evaluation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#generate-heatmaps">Generate heatmaps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="activations.html">Layer activations</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="slideflow.html">Source</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="root.html">slideflow</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="root.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Evaluation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/evaluation.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="evaluation">
<h1>Evaluation<a class="headerlink" href="#evaluation" title="Permalink to this headline">¶</a></h1>
<p>Once training and hyperparameter tuning is complete, you can test model performance on your held-out evaluation set using the <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> function. Specify the path to the saved with the <code class="docutils literal notranslate"><span class="pre">model</span></code> argument. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">SFP</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;/path/to/trained_model_epoch1&quot;</span><span class="p">,</span>
        <span class="n">outcome_label_headers</span><span class="o">=</span><span class="s2">&quot;category&quot;</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dataset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;evaluation&quot;</span><span class="p">]})</span>
</pre></div>
</div>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">slideflow.SlideflowProject.</span></span><span class="sig-name descname"><span class="pre">evaluate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">outcome_label_headers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hyperparameters</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">filters</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">checkpoint</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">eval_k_fold</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_tiles_per_slide</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_tiles_per_slide</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">normalizer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">normalizer_source</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">input_header</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">permutation_importance</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">histogram</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">save_predictions</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Evaluates a saved model on a given set of tfrecords.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>model</strong> – Path to Tensorflow model to evaluate.</p></li>
<li><p><strong>outcome_label_headers</strong> – Annotation column header that specifies the outcome label(s).</p></li>
<li><p><strong>hyperparameters</strong> – Path to model’s hyperparameters.json file. If None (default), searches for this file in the same directory as the model.</p></li>
<li><p><strong>filters</strong> – Filters to use when selecting tfrecords on which to perform evaluation.</p></li>
<li><p><strong>checkpoint</strong> – Path to cp.ckpt file to load, if evaluating a saved checkpoint.</p></li>
<li><p><strong>eval_k_fold</strong> – K-fold iteration number to evaluate. If None, will evaluate all tfrecords irrespective of K-fold.</p></li>
<li><p><strong>max_tiles_per_slide</strong> – Will only use up to this many tiles from each slide for evaluation. If zero, will include all tiles.</p></li>
<li><p><strong>min_tiles_per_slide</strong> – Minimum number of tiles a slide must have to be included in evaluation. Default is 0, but
for best slide-level AUC, a minimum of at least 10 tiles per slide is recommended.</p></li>
<li><p><strong>normalizer</strong> – Normalization strategy to use on image tiles.</p></li>
<li><p><strong>normalizer_source</strong> – Path to normalizer source image.</p></li>
<li><p><strong>input_header</strong> – Annotation column header to use as additional input to the model.</p></li>
<li><p><strong>permutation_importance</strong> – Bool. True if you want to calculate the permutation feature importance (used to determine relative importance when using multiple model inputs</p></li>
<li><p><strong>histogram</strong> – Bool. If true, will create tile-level histograms to show prediction distributions for each class.</p></li>
<li><p><strong>save_predictions</strong> – Either True, False, or a list with any combination of ‘tile’, ‘patient’, or ‘slide’.
Will save tile-level, patient-level, and/or slide-level predictions.
If True, will save all.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<div class="section" id="generate-heatmaps">
<h2>Generate heatmaps<a class="headerlink" href="#generate-heatmaps" title="Permalink to this headline">¶</a></h2>
<p>To generate a predictive heatmap for a set of slides, use the <code class="docutils literal notranslate"><span class="pre">generate_heatmaps()</span></code> function as below, which will automatically save heatmap images in your project directory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">SFP</span><span class="o">.</span><span class="n">generate_heatmaps</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;/path/to/trained_model_epoch1&quot;</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dataset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;evaluation&quot;</span><span class="p">]})</span>
</pre></div>
</div>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">slideflow.SlideflowProject.</span></span><span class="sig-name descname"><span class="pre">generate_heatmaps</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">filters</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">filter_blank</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">directory</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">resolution</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'low'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">interpolation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'none'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">show_roi</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">roi_method</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'inside'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">logit_cmap</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">normalizer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">normalizer_source</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">buffer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">isolated_thread</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_threads</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'auto'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_format</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Creates predictive heatmap overlays on a set of slides.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>model</strong> – Path to Tensorflow model with which predictions will be generated.</p></li>
<li><p><strong>filters</strong> – Dataset filters to use when selecting slides for which to generate heatmaps.</p></li>
<li><p><strong>filter_blank</strong> – List of label headers; slides that have blank entries in this label header
in the annotations file will be excluded</p></li>
<li><p><strong>directory</strong> – Directory in which to save heatmap images.</p></li>
<li><p><strong>resolution</strong> – Heatmap resolution (determines stride of tile predictions).
“low” uses a stride equal to tile width.
“medium” uses a stride equal 1/2 tile width.
“high” uses a stride equal to 1/4 tile width.</p></li>
<li><p><strong>interpolation</strong> – Interpolation strategy for smoothing heatmap predictions (matplotlib imshow interpolation options).</p></li>
<li><p><strong>show_roi</strong> – Bool. If True, will show ROI on heatmaps.</p></li>
<li><p><strong>roi_method</strong> – ‘inside’, ‘outside’, or ‘none’. Determines where heatmap should be made with respect to annotated ROI.</p></li>
<li><p><strong>logit_cmap</strong> – <p>Either a function or a dictionary used to create heatmap colormap.
If None (default), separate heatmaps will be generated for each label category, with color representing likelihood of category prediction.
Each image tile will generate a list of predictions of length O,
where O is the number of label categories.
If logit_cmap is a function, then this logit prediction list will be passed to the function,
and the function is expected to return [R, G, B] values which will be displayed. isolated_thread must be true if a function is passed.
If the logit_cmap is a dictionary, it should map ‘r’, ‘g’, and ‘b’ to label indices;
The prediction for these label categories will be mapped to the corresponding colors.
Thus, the corresponding color will only reflect predictions of up to three label categories.</p>
<blockquote>
<div><p>Example (this would map prediction for label 0 to the red colorspace, label 3 to green colorspace, etc):
{‘r’: 0, ‘g’: 3, ‘b’: 1 }</p>
</div></blockquote>
</p></li>
<li><p><strong>normalizer</strong> – Normalization strategy to use on image tiles</p></li>
<li><p><strong>normalizer_source</strong> – Path to normalizer source image</p></li>
<li><p><strong>buffer</strong> – Either ‘vmtouch’ or path to directory. If vmtouch, will use vmtouch to preload slide into memory before extraction.
If a directory, slides will be copied to the directory as a buffer before extraction.
Either method vastly improves tile extraction for slides on HDDs by maximizing sequential read speed</p></li>
<li><p><strong>isolated_thread</strong> – Bool. If True, will wrap function in separate process, allowing GPU memory to be freed after completion.
If False, will perform as single thread (GPU memory may not be freed after completion).
Allows use for functions being passed to logit_cmap (functions are not pickleable).</p></li>
<li><p><strong>model_format</strong> – Optional. May supply format of saved Slideflow Keras model if the model was made with a legacy version.
Default value will be slideflow.model.MODEL_FORMAT_CURRENT,
but slideflow.model.MODEL_FORMAT_LEGACY may be supplied.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p>If you would like to directly interact with the calculated heatmap data, create a <code class="docutils literal notranslate"><span class="pre">sf.activations.Heatmap</span></code> object by providing a path to a slide, a path to a model, and tile size information:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">heatmap</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="s1">&#39;/path/to/slide.svs&#39;</span><span class="p">,</span> <span class="s1">&#39;/path/to/model.h5&#39;</span><span class="p">,</span> <span class="n">size_px</span><span class="o">=</span><span class="mi">299</span><span class="p">,</span> <span class="n">size_um</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>
</pre></div>
</div>
<p>The spatial map of logits, as calculated across the input slide, can be accessed through <code class="docutils literal notranslate"><span class="pre">heatmap.logits</span></code>. The spatial map of post-convolution, penultimate activations can be accessed through <code class="docutils literal notranslate"><span class="pre">heatmap.postconv</span></code>. The heatmap can be saved with <code class="docutils literal notranslate"><span class="pre">heatmap.save('/path/')</span></code>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="activations.html" class="btn btn-neutral float-right" title="Layer activations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="training.html" class="btn btn-neutral float-left" title="Training" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, James M Dolezal.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>